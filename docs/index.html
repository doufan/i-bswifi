<!DOCTYPE html>
<!-- saved from url=(0076)http://wiki.n.miui.com/plugins/viewsource/viewpagesrc.action?pageId=70115818 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>米家蓝牙认证库说明</title>
        <link rel="canonical" href="http://wiki.n.miui.com/pages/viewpage.action?pageId=$action.page.id">
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\u0022\u0022";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script>
<link type="text/css" rel="stylesheet" href="./index_files/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/dba054264c6a0c1425b5ffebae0b3405-CDN/zh_CN/7111/583f3f4010922d699723a091097524472954c767/e860d0fc70e2f6d6e8992c9ce453f407/_/download/contextbatch/css/_super/batch.css?conditionalComment=lt+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/dba054264c6a0c1425b5ffebae0b3405-CDN/zh_CN/7111/583f3f4010922d699723a091097524472954c767/e860d0fc70e2f6d6e8992c9ce453f407/_/download/contextbatch/css/_super/batch.css?conditionalComment=lte+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="./index_files/batch(1).css" data-wrm-key="plugin.viewsource,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./index_files/batch(2).css" data-wrm-key="page,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./index_files/batch(3).css" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/5333d01b74d28ccfa1b186a79244abaf-CDN/zh_CN/7111/583f3f4010922d699723a091097524472954c767/69ffe195e7dc9fc8ab78c5f7d7e157a1/_/download/contextbatch/css/editor-content,-_super/batch.css?conditionalComment=lte+IE+9&amp;confluence.table.resizable=true&amp;confluence.view.edit.transition=true" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="./index_files/custom.css" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <h2 class="auto-cursor-target">米家蓝牙标准认证库说明</h2><hr><p>mible_std_authen库是接入米家的蓝牙设备与米家app之间标准认证库，用于普通安全等级的设备接入米家APP。mible_std_authen_xxxx.lib 库会在蓝牙设备端建立Mi Service服务，用于认证交互。认证库基于米家蓝牙通用接口实现 <a href="https://github.com/MiEcosystem/mijia_ble_api/tree/release-1.0">https://github.com/MiEcosystem/mijia_ble_api/tree/release-1.0</a>，此接口目前已经适配了不同的芯片平台，可以在多个平台上运行。 认证库中可供应用层使用的接口在mible_server.h文件中定义。</p><p>各接口功能如下：</p><table class="wrapped confluenceTable"><colgroup><col><col><col></colgroup><tbody><tr><th class="confluenceTh"><p>函数名</p></th><th class="confluenceTh"><p>功能</p></th><th class="confluenceTh"><p>说明</p></th></tr><tr><td class="confluenceTd"><p>mible_server_info_init</p></td><td class="confluenceTd"><p>初始化设备信息</p></td><td class="confluenceTd"><p>初始化一下参数：</p><p>1、绑定关系（强/弱），需与米家开放平台上强弱<span>绑定</span><span>配置</span>一致</p><p>2、产品id，需与米家开放平台上产品ID配置一致</p><p>3、版本号（四位数字字符如”1234”）</p></td></tr><tr><td class="confluenceTd"><p>mible_server_miservice_init</p></td><td class="confluenceTd"><p>初始化MiService</p></td><td class="confluenceTd"><p>用于初始化MiService，在初始化阶段调用</p></td></tr><tr><td class="confluenceTd"><p>mible_service_init_cmp</p></td><td class="confluenceTd"><p>MI SERVICE初始化完成回调函数</p></td><td class="confluenceTd"><p>当MiService初始化完成，会调用此函数，此函数可以在应用层实现。</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>mible_connected</p></td><td colspan="1" class="confluenceTd"><p>连接回调函数</p></td><td colspan="1" class="confluenceTd"><p>当设备与app建立连接，会调用此函数，此函数可在应用层实现。</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>mible_disconnected</p></td><td colspan="1" class="confluenceTd"><p>断开连接回调函数</p></td><td colspan="1" class="confluenceTd"><p>当设备与app断开连接，会调用</p></td></tr><tr><td colspan="1" class="confluenceTd"><p>mible_bonding_evt_callback</p></td><td colspan="1" class="confluenceTd"><p>认证结果回调函数</p></td><td colspan="1" class="confluenceTd"><p>设备第一次与米家app连接时，进入绑定流程，此函数返回绑定成功或失败的结果；绑定成功后(设备输入手机app的账号名下)，设备每次与app建立连接，都进行登录流程，此函数返回登录成功或失败的结果。</p><p>【注】建立连接后，在未绑定或登录成功前，设备端不能允许任何对设备的操作，如读写特性等。</p></td></tr></tbody></table><p><br></p><p>此外在mible_server.h文件中，还有一些参数可供应用层修改：</p><table class="relative-table wrapped confluenceTable" style="width: 33.0225%;"><colgroup><col style="width: 56.0732%;"><col style="width: 43.9268%;"></colgroup><tbody><tr><th class="confluenceTh">宏定义</th><th class="confluenceTh">说明</th></tr><tr><td class="confluenceTd">MIBLE_STD_SERVER_CONN_MAX_INTERVAL</td><td class="confluenceTd">最大连接间隔</td></tr><tr><td class="confluenceTd">MIBLE_STD_SERVER_CONN_MIN_INTERVAL</td><td class="confluenceTd">最小连接间隔</td></tr><tr><td colspan="1" class="confluenceTd">MIBLE_STD_SERVER_CONN_SLAVE_LATENCY</td><td colspan="1" class="confluenceTd">从设备连接延迟</td></tr><tr><td colspan="1" class="confluenceTd">MIBLE_STD_SERVER_CONN_SUP_TIMEOUT</td><td colspan="1" class="confluenceTd">连接超时时间</td></tr></tbody></table><h2>调用实例</h2><hr><p>目前已发布了多个芯片平台的硬件调用实例Demo，<a href="https://github.com/MiEcosystem/mijia_ble">https://github.com/MiEcosystem/mijia_ble</a></p><p>实例Demo中展示了如何使用米家蓝牙标准认证库，具体使用流程如下：</p><ol><li>完成必要的初始化工作，如蓝牙协议栈初始化、flash记录初始化、timer初始化等，使得米家通用蓝牙接口可以正常工作；</li><li><span>调用&nbsp;<span>mible_server_info_init 函数，完成产品信息的初始化配置；</span></span></li><li><span><span>调用 mible_server_miservice_init 函数，初始化用于米家认证 Service 和 characteristic。&nbsp; Service UUID 为 0xFE95。&nbsp;</span></span></li></ol><p>运行认证库的蓝牙设备为slave，当手机米家app作为master连接蓝牙设备时，会触发认证流程。 当设备第一次建立连接时，触发绑定流程。若绑定成功，则此后建立连接都会触发<span>登录</span>流程。建立连接后，若未成功进行绑定或登陆，超时10s后会自动断开连接。认证库开放给应用层四个回调函数，用户可以在回调函数中添加自己的应用层代码，四个回调函数如下：</p><ol><li><span>mible_service_init_cmp 认证用的service 初始化完成回调函数；</span></li><li><span><span>mible_connected 建立连接回调函数；</span><br></span></li><li><span><span><span>mible_disconnected&nbsp;<span>断开连接回调函数；</span></span><br></span></span></li><li><span><span><span><span><span>mible_bonding_evt_callback&nbsp;<span>认证结果回调函数。</span></span></span></span></span></span></li></ol><p>在绑定成功后，会将设备认证的相关信息存储在flash中。如果flash存储不成功会导致此后的的登录流程不成功。</p><h2>平台支持情况</h2><table class="wrapped relative-table confluenceTable" style="width: 30.7735%;"><colgroup><col style="width: 13.0357%;"><col style="width: 14.2857%;"><col style="width: 14.2857%;"><col style="width: 12.6786%;"><col style="width: 26.9643%;"><col style="width: 18.75%;"><col></colgroup><tbody><tr><th colspan="1" class="confluenceTh">Vendor</th><th class="confluenceTh">Platform</th><th colspan="1" class="confluenceTh">SDK version</th><th class="confluenceTh">mible api</th><th class="confluenceTh">mible_std_authen <span>sdk</span></th><th class="confluenceTh">version1.0</th><th colspan="1" class="confluenceTh"><span>version1.1.2</span></th></tr><tr><td rowspan="2" class="confluenceTd"><span>Nordic</span></td><td class="confluenceTd">52</td><td rowspan="2" class="confluenceTd">12.3.0</td><td class="confluenceTd">√</td><td class="confluenceTd"><span>√</span></td><td class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">51</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">Silicon labs</td><td colspan="1" class="confluenceTd">BG13</td><td colspan="1" class="confluenceTd">2.9.0</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd"><br></td></tr><tr><td colspan="1" class="confluenceTd">NXP</td><td colspan="1" class="confluenceTd">QN908x</td><td colspan="1" class="confluenceTd">2.2</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd">QN9090</td><td colspan="1" class="confluenceTd">无官方下载渠道</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">Dialog</td><td colspan="1" class="confluenceTd">DA14585</td><td colspan="1" class="confluenceTd"><span style="color: rgb(36,41,46);">6.0.6.427</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">Cypress</td><td colspan="1" class="confluenceTd">20706</td><td colspan="1" class="confluenceTd">6.x</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">ST</td><td colspan="1" class="confluenceTd">BlueNRG-1</td><td colspan="1" class="confluenceTd">2.6.0</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><br></td><td colspan="1" class="confluenceTd"><span>√</span></td></tr><tr><td colspan="1" class="confluenceTd">Telink</td><td colspan="1" class="confluenceTd">8269</td><td colspan="1" class="confluenceTd">2.3</td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><span>√</span></td><td colspan="1" class="confluenceTd"><br></td></tr></tbody></table><p class="auto-cursor-target">mible_api ： <a href="https://github.com/MiEcosystem/mijia_ble_api.git">https://github.com/MiEcosystem/mijia_ble_api.git</a></p><p>mible_common:&nbsp;&nbsp;<a href="https://github.com/MiEcosystem/mijia_ble_common.git">https://github.com/MiEcosystem/mijia_ble_common.git</a></p><p>mible sdk:&nbsp;&nbsp;<a href="https://github.com/MiEcosystem/mijia_ble.git">https://github.com/MiEcosystem/mijia_ble.git</a></p><p><br></p><p><br></p><p><br></p>
        <p>&nbsp;</p>
    

</body></html>
